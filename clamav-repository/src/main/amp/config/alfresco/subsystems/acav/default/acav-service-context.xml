<?xml version='1.0' encoding='UTF-8'?>

<beans xmlns="http://www.springframework.org/schema/beans" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd">

  <bean id="acav.abstractService" class="org.redpill.alfresco.clamav.repo.service.impl.AbstractService" abstract="true">
    <property name="lockService" ref="LockService" />
    <property name="nodeService" ref="NodeService" />
    <property name="acavNodeService" ref="acav.nodeService" />
  </bean>

  <bean id="acav.updateVirusDatabaseService" class="org.redpill.alfresco.clamav.repo.service.impl.UpdateVirusDatabaseServiceImpl" parent="acav.abstractService">
    <property name="updateVirusDatabaseCommand" ref="acav.updateVirusDatabaseCommand" />
    <property name="updateVirusDatabaseCheckCommand" ref="acav.updateVirusDatabaseCheckCommand" />
    <property name="datadir" value="${acav.datadir}" />
  </bean>

  <bean name="acav.updateVirusDatabaseCommand" class="org.alfresco.util.exec.RuntimeExec">
    <property name="commandsAndArguments">
      <map>
        <entry key=".*">
          <list>
            <value>${freshclam.exe}</value>
            <value>--datadir=${acav.datadir}</value>
            <value>--log=${logfile}</value>
            <value>SPLIT:${options}</value>
          </list>
        </entry>
      </map>
    </property>
  </bean>

  <bean name="acav.updateVirusDatabaseCheckCommand" class="org.alfresco.util.exec.RuntimeExec">
    <property name="commandsAndArguments">
      <map>
        <entry key=".*">
          <list>
            <value>${freshclam.exe}</value>
            <value>--version</value>
          </list>
        </entry>
      </map>
    </property>
  </bean>

  <bean id="acav.nodeService" class="org.redpill.alfresco.clamav.repo.service.impl.AcavNodeServiceImpl">
    <property name="nodeService" ref="NodeService" />
    <property name="searchService" ref="SearchService" />
    <property name="fileFolderService" ref="FileFolderService" />
    <property name="permissionService" ref="PermissionService" />
  </bean>

  <bean id="acav.systemScanDirectoryRegistry" class="org.redpill.alfresco.clamav.repo.service.impl.SystemScanDirectoryRegistryImpl" />

  <bean id="acav.systemScanDirectoryContentStore" class="org.redpill.alfresco.clamav.repo.utils.SystemScanDirectoryRegister">
    <property name="systemScanDirectoryRegistry" ref="acav.systemScanDirectoryRegistry" />
    <property name="systemScanDirectory" value="${dir.contentstore}" />
  </bean>

  <bean id="acav.scanService" class="org.redpill.alfresco.clamav.repo.service.impl.ScanServiceImpl" parent="acav.abstractService">
    <property name="scanCommand" ref="acav.scanCommand" />
    <property name="checkCommand" ref="acav.scanCheckCommand" />
    <property name="contentService" ref="ContentService" />
    <property name="fileFolderService" ref="FileFolderService" />
    <property name="systemScanDirectoryRegistry" ref="acav.systemScanDirectoryRegistry" />
    <property name="acavNodeService" ref="acav.nodeService" />
    <property name="lockService" ref="LockService" />
    <property name="nodeService" ref="NodeService" />
    <property name="scanHistoryService" ref="acav.scanHistoryService" />
    <property name="nodeDao" ref="acav.nodeDao" />
    <property name="searchService" ref="SearchService" />
  </bean>

  <bean name="acav.scanCommand" class="org.alfresco.util.exec.RuntimeExec">
    <property name="commandsAndArguments">
      <map>
        <entry key=".*">
          <list>
            <value>${clamscan.exe}</value>
            <value>--tempdir=${tempdir}</value>
            <value>--database=${acav.datadir}</value>
            <value>--log=${logfile}</value>
            <value>SPLIT:${options}</value>
            <value>${file_to_scan}</value>
          </list>
        </entry>
      </map>
    </property>
  </bean>

  <bean name="acav.scanCheckCommand" class="org.alfresco.util.exec.RuntimeExec">
    <property name="commandsAndArguments">
      <map>
        <entry key=".*">
          <list>
            <value>${clamscan.exe}</value>
            <value>--version</value>
          </list>
        </entry>
      </map>
    </property>
  </bean>

  <bean id="acav.scanAction" class="org.redpill.alfresco.clamav.repo.service.impl.ScanActionImpl">
    <property name="nodeService" ref="NodeService" />
    <property name="fileFolderService" ref="FileFolderService" />
    <property name="searchService" ref="SearchService" />
    <property name="behaviourFilter" ref="policyBehaviourFilter" />
    <property name="acavNodeService" ref="acav.nodeService" />
  </bean>

  <bean id="acav.scanHistoryService" class="org.redpill.alfresco.clamav.repo.service.impl.ScanHistoryServiceImpl">
    <property name="acavNodeService" ref="acav.nodeService" />
    <property name="fileFolderService" ref="FileFolderService" />
    <property name="nodeService" ref="NodeService" />
  </bean>

</beans>
